<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éâ„É©„Ç§„Éê„ÉºÊó•Â†±„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 12px 24px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-section {
            margin-bottom: 35px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .form-section h3 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 8px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group.full-width {
            flex: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: #4a90e2;
            background: #f8f9ff;
        }

        .radio-item input[type="radio"]:checked + .radio-label {
            color: #4a90e2;
            font-weight: 600;
        }

        .radio-item:has(input[type="radio"]:checked) {
            border-color: #4a90e2;
            background: #f8f9ff;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #4a90e2;
            background: #f8f9ff;
        }

        .checkbox-item input[type="checkbox"]:checked + .checkbox-label {
            color: #4a90e2;
            font-weight: 600;
        }

        .checkbox-item:has(input[type="checkbox"]:checked) {
            border-color: #4a90e2;
            background: #f8f9ff;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(74, 144, 226, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        /* ÊôÇÂàªË®òÈå≤„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .time-record-btn {
            padding: 15px 25px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .time-record-btn.start {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .time-record-btn.end {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .time-record-btn.site {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .time-record-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .time-record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .time-display {
            font-size: 1.3em;
            font-weight: bold;
            color: #4a90e2;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 2px solid #e3f2fd;
        }

        /* ÁèæÂ†¥ÁÆ°ÁêÜ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .sites-container {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .sites-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
        }

        .site-item {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .site-item.completed {
            background: #f8f9fa;
            opacity: 0.8;
        }

        .site-item:last-child {
            border-bottom: none;
        }

        .site-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .site-status.in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .site-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .current-site {
            border: 3px solid #4a90e2;
            background: #f8f9ff;
        }

        /* ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ */
        .photo-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .photo-upload-area:hover {
            border-color: #4a90e2;
            background: #f8f9ff;
        }

        .photo-upload-area.drag-over {
            border-color: #4a90e2;
            background: #e3f2fd;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .photo-preview-grid:empty::before {
            content: '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„ÅüÂÜôÁúü„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô';
            color: #999;
            font-style: italic;
            display: block;
            text-align: center;
            padding: 20px;
            grid-column: 1 / -1;
        }

        .photo-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-preview img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .photo-preview .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        .photo-preview .photo-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 5px;
            font-size: 0.75em;
            text-align: center;
            word-wrap: break-word;
        }
        
        .photo-upload-summary {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .photo-upload-summary .count {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976d2;
        }
        
        .photo-type-label {
            display: inline-block;
            background: #4a90e2;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-bottom: 5px;
        }
        
        .clear-all-photos {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background 0.3s ease;
        }
        
        .clear-all-photos:hover {
            background: #c82333;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .admin-table th,
        .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .admin-table th {
            background: #4a90e2;
            color: white;
            font-weight: 600;
        }

        .admin-table tr:hover {
            background: #f8f9ff;
        }

        .status-submitted {
            color: #28a745;
            font-weight: 600;
        }

        .status-pending {
            color: #ffc107;
            font-weight: 600;
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .driver-management {
            margin-bottom: 30px;
        }

        .driver-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .driver-tag {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            position: relative;
        }

        .driver-tag .remove-btn {
            margin-left: 8px;
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }


        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #4a90e2;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1em;
        }

        .login-form-group {
            margin-bottom: 25px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .login-form-group select,
        .login-form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        .login-form-group select:focus,
        .login-form-group input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.3);
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .user-info .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        .login-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .my-page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .my-page-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .my-page-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .my-reports-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .my-reports-list h4 {
            color: #4a90e2;
            margin-bottom: 15px;
        }

        .report-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-card:hover {
            border-color: #4a90e2;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
        }

        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .report-card-date {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a90e2;
        }

        .report-card-status {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .report-card-body {
            color: #666;
            font-size: 0.9em;
        }

        .report-card-body div {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .form-row {
                flex-direction: column;
            }

            .form-group {
                min-width: auto;
            }

            .radio-group {
                flex-direction: column;
            }

            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .navigation {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 200px;
                text-align: center;
            }

            .time-record-btn {
                min-width: auto;
                width: 100%;
            }

            .photo-preview-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            
            .photo-preview img {
                height: 120px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .required {
            color: #dc3545;
        }

        .form-group input:required:invalid {
            border-color: #dc3545;
        }

        .form-group input:required:valid {
            border-color: #28a745;
        }

        .hidden {
            display: none !important;
        }

        /* ‰ºëÊÜ©ÊôÇÈñìÁÆ°ÁêÜ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .break-time-section {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border: 3px solid #fdcb6e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .break-time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .break-time-header h4 {
            color: #d63031;
            font-size: 1.3em;
            margin: 0;
        }

        .break-remaining {
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .break-remaining.complete {
            background: #00b894;
            color: white;
        }

        .break-remaining.warning {
            background: #fdcb6e;
            color: #2d3436;
        }

        .break-remaining.danger {
            background: #d63031;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .break-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .break-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .break-btn.start {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .break-btn.end {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
        }

        .break-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .break-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .break-history {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .break-history h5 {
            color: #2d3436;
            margin-bottom: 10px;
        }

        .break-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid #0984e3;
        }

        .break-item .time {
            font-weight: bold;
            color: #0984e3;
        }

        .break-item .duration {
            color: #00b894;
            font-weight: bold;
        }

        .labor-time-summary {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .labor-time-summary h4 {
            color: #1976d2;
            margin-bottom: 15px;
            text-align: center;
        }

        .labor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .labor-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .labor-item .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .labor-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #1976d2;
        }

        .labor-item.overtime .value {
            color: #ff9800;
        }

        .labor-item.night .value {
            color: #9c27b0;
        }

        .labor-item.holiday .value {
            color: #f44336;
        }


        /* „É¢„Éº„ÉÄ„É´„Çπ„Çø„Ç§„É´ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
        }

        .modal-close {
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4a90e2;
        }

        .detail-section h3 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .detail-item label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            display: block;
            margin-bottom: 5px;
        }

        .detail-item .value {
            color: #333;
            font-size: 1.1em;
        }

        .site-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .site-card:hover {
            border-color: #4a90e2;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
        }

        .site-card-header {
            background: #4a90e2;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .photo-gallery-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .photo-gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-gallery-item .pdf-preview {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .photo-gallery-item .pdf-preview .icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        .photo-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            font-size: 0.85em;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }

        .btn-print {
            background: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-print:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .inspection-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .inspection-badge {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* ÁîªÂÉèÊã°Â§ß„É¢„Éº„ÉÄ„É´ */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            justify-content: center;
            align-items: center;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 30px;
            right: 50px;
            color: white;
            font-size: 50px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .modal-content, .modal-content * {
                visibility: visible;
            }
            .modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                margin: 0;
                box-shadow: none;
            }
            .modal-close, .modal-actions {
                display: none !important;
            }
        }


        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #4a90e2;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 1em;
        }

        .login-form-group {
            margin-bottom: 25px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .login-form-group select,
        .login-form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        .login-form-group select:focus,
        .login-form-group input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.3);
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .user-info .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        .login-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .my-page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .my-page-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .my-page-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .my-reports-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .my-reports-list h4 {
            color: #4a90e2;
            margin-bottom: 15px;
        }

        .report-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-card:hover {
            border-color: #4a90e2;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
        }

        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .report-card-date {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a90e2;
        }

        .report-card-status {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .report-card-body {
            color: #666;
            font-size: 0.9em;
        }

        .report-card-body div {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .modal-body {
                padding: 20px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .photo-gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .photo-gallery-item img,
            .photo-gallery-item .pdf-preview {
                height: 150px;
            }
        }

        .paste-help {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>üöõ „Éâ„É©„Ç§„Éê„ÉºÊó•Â†±„Ç∑„Çπ„ÉÜ„É†</h1>
                <p>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
            
            <div class="login-form-group">
                <label for="loginDriver">„Éâ„É©„Ç§„Éê„ÉºÂêç„ÇíÈÅ∏Êäû</label>
                <select id="loginDriver">
                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                    <option value="Áî∞Â≥∂">Áî∞Â≥∂</option>
                    <option value="Á¶èÁî∞">Á¶èÁî∞</option>
                    <option value="ÂÜÖÁî∞">ÂÜÖÁî∞</option>
                    <option value="Ëõ≠Â∑ù">Ëõ≠Â∑ù</option>
                    <option value="Áî∞Èáå">Áî∞Èáå</option>
                    <option value="Êà∏Â±±">Êà∏Â±±</option>
                    <option value="ÊùæÊ©ã">ÊùæÊ©ã</option>
                    <option value="Â†ÄÁ±≥">Â†ÄÁ±≥</option>
                    <option value="Â∞èÊöÆ">Â∞èÊöÆ</option>
                    <option value="Â∑•Ëó§">Â∑•Ëó§</option>
                    <option value="ÊØîÂòâ">ÊØîÂòâ</option>
                    <option value="Ëó§Èáé">Ëó§Èáé</option>
                    <option value="Ë•øÊ¢ù">Ë•øÊ¢ù</option>
                    <option value="‰ªä‰∫ïÂØø">‰ªä‰∫ïÂØø</option>
                    <option value="‰ªä‰∫ïÊ∏Ö">‰ªä‰∫ïÊ∏Ö</option>
                    <option value="‰Ωê‰πÖÈñì">‰Ωê‰πÖÈñì</option>
                    <option value="ÁæΩÈ≥•">ÁæΩÈ≥•</option>
                    <option value="Â±±‰∏≠">Â±±‰∏≠</option>
                    <option value="È¢®Èñì">È¢®Èñì</option>
                    <option value="Â≤©Áî∞">Â≤©Áî∞</option>
                    <option value="Ê©ãÊú¨">Ê©ãÊú¨</option>
                    <option value="Â••Èáé">Â••Èáé</option>
                    <option value="Áü≥Âû£">Áü≥Âû£</option>
                    <option value="ÂéüÁî∞">ÂéüÁî∞</option>
                    <option value="È´ôÊ©ã">È´ôÊ©ã</option>
                    <option value="Èà¥Êú®">Èà¥Êú®</option>
                    <option value="‰ΩêËó§">‰ΩêËó§</option>
                    <option value="Êü≥">Êü≥</option>
                    <option value="Á¶èÂ≥∂">Á¶èÂ≥∂</option>
                </select>
            </div>
            
            <button class="login-btn" onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
            
            <div class="login-info">
                üí° „Éí„É≥„Éà: ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÇíÈñâ„Åò„Å¶„ÇÇ„Éá„Éº„Çø„Åå‰øùÊåÅ„Åï„Çå„Åæ„Åô
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <h1>„Éâ„É©„Ç§„Éê„ÉºÊó•Â†±„Ç∑„Çπ„ÉÜ„É†</h1>
            <p>ÂäπÁéáÁöÑ„Å™Êó•Â†±ÁÆ°ÁêÜ„ÅßÂÆâÂÖ®ÈÅãË°å„Çí„Çµ„Éù„Éº„Éà</p>
            <div class="user-info">
                <span>üë§ „É≠„Ç∞„Ç§„É≥‰∏≠:</span>
                <span class="user-name" id="currentUserName"></span>
                <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
            <div class="navigation">
                <button class="nav-btn active" onclick="showSection('driver')">Êó•Â†±ÂÖ•Âäõ</button>
                <button class="nav-btn" onclick="showSection('mypage')">„Éû„Ç§„Éö„Éº„Ç∏</button>
                <button class="nav-btn" onclick="showSection('admin')">ÁÆ°ÁêÜËÄÖÁîªÈù¢</button>
            </div>
        </div>

        <div class="content">
            <div id="driver-section" class="section active">
                <form id="reportForm">
                    <div class="form-section">
                        <h3>Âü∫Êú¨ÊÉÖÂ†±</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date">Êó•‰ªò <span class="required">*</span></label>
                                <input type="date" id="date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="driver">„Éâ„É©„Ç§„Éê„ÉºÂêç <span class="required">*</span></label>
                                <select id="driver" name="driver" required>
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="Áî∞Â≥∂">Áî∞Â≥∂</option>
                                    <option value="Á¶èÁî∞">Á¶èÁî∞</option>
                                    <option value="ÂÜÖÁî∞">ÂÜÖÁî∞</option>
                                    <option value="Ëõ≠Â∑ù">Ëõ≠Â∑ù</option>
                                    <option value="Áî∞Èáå">Áî∞Èáå</option>
                                    <option value="Êà∏Â±±">Êà∏Â±±</option>
                                    <option value="ÊùæÊ©ã">ÊùæÊ©ã</option>
                                    <option value="Â†ÄÁ±≥">Â†ÄÁ±≥</option>
                                    <option value="Â∞èÊöÆ">Â∞èÊöÆ</option>
                                    <option value="Â∑•Ëó§">Â∑•Ëó§</option>
                                    <option value="ÊØîÂòâ">ÊØîÂòâ</option>
                                    <option value="Ëó§Èáé">Ëó§Èáé</option>
                                    <option value="Ë•øÊ¢ù">Ë•øÊ¢ù</option>
                                    <option value="‰ªä‰∫ïÂØø">‰ªä‰∫ïÂØø</option>
                                    <option value="‰ªä‰∫ïÊ∏Ö">‰ªä‰∫ïÊ∏Ö</option>
                                    <option value="‰Ωê‰πÖÈñì">‰Ωê‰πÖÈñì</option>
                                    <option value="ÁæΩÈ≥•">ÁæΩÈ≥•</option>
                                    <option value="Â±±‰∏≠">Â±±‰∏≠</option>
                                    <option value="È¢®Èñì">È¢®Èñì</option>
                                    <option value="Â≤©Áî∞">Â≤©Áî∞</option>
                                    <option value="Ê©ãÊú¨">Ê©ãÊú¨</option>
                                    <option value="Â••Èáé">Â••Èáé</option>
                                    <option value="Áü≥Âû£">Áü≥Âû£</option>
                                    <option value="ÂéüÁî∞">ÂéüÁî∞</option>
                                    <option value="È´ôÊ©ã">È´ôÊ©ã</option>
                                    <option value="Èà¥Êú®">Èà¥Êú®</option>
                                    <option value="‰ΩêËó§">‰ΩêËó§</option>
                                    <option value="Êü≥">Êü≥</option>
                                    <option value="Á¶èÂ≥∂">Á¶èÂ≥∂</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>‰ΩìË™ø <span class="required">*</span></label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="condition-good" name="condition" value="ËâØ„ÅÑ" required>
                                        <label for="condition-good" class="radio-label">ËâØ„ÅÑ</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="condition-normal" name="condition" value="ÊôÆÈÄö" required>
                                        <label for="condition-normal" class="radio-label">ÊôÆÈÄö</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="condition-bad" name="condition" value="ÊÇ™„ÅÑ" required>
                                        <label for="condition-bad" class="radio-label">ÊÇ™„ÅÑ</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Êò®Êô©„ÅÆ„Ç¢„É´„Ç≥„Éº„É´ÊëÇÂèñ <span class="required">*</span></label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="alcohol-yes" name="alcohol" value="È£≤„Çì„Å†" required>
                                        <label for="alcohol-yes" class="radio-label">È£≤„Çì„Å†</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="alcohol-no" name="alcohol" value="È£≤„Çì„Åß„ÅÑ„Å™„ÅÑ" required>
                                        <label for="alcohol-no" class="radio-label">È£≤„Çì„Åß„ÅÑ„Å™„ÅÑ</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>„Ç¢„É´„Ç≥„Éº„É´Êï∞ÂÄ§ <span class="required">*</span></label>
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="alcohol-level-zero" name="alcoholLevel" value="0.00" required>
                                        <label for="alcohol-level-zero" class="radio-label">0.00</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="alcohol-level-over" name="alcoholLevel" value="0.00‰ª•‰∏ä" required>
                                        <label for="alcohol-level-over" class="radio-label">0.00‰ª•‰∏ä</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Ê•≠ÂãôÈñãÂßãË®òÈå≤</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ê•≠ÂãôÈñãÂßã</label>
                                <button type="button" class="time-record-btn start" onclick="recordStartTime()">
                                    üìç Áõ¥Ë°å
                                </button>
                                <div id="startTimeDisplay" class="time-display hidden"></div>
                                <input type="hidden" id="startTime" name="startTime">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ÁèæÂ†¥ÊÉÖÂ†±</h3>
                        <div class="sites-container">
                            <div class="sites-header">ÂõûÂèéÁèæÂ†¥‰∏ÄË¶ß</div>
                            <div id="sitesContainer"></div>
                            <div class="site-item current-site" id="currentSite">
                                <div class="site-status in-progress">‰ΩúÊ•≠‰∏≠</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <button type="button" class="time-record-btn site" onclick="recordSiteArrival()">
                                            üöõ ÁèæÂ†¥Âà∞ÁùÄ
                                        </button>
                                        <div id="currentSiteArrivalDisplay" class="time-display hidden"></div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="currentSiteName">ÁèæÂ†¥Âêç <span class="required">*</span></label>
                                        <textarea id="currentSiteName" rows="2" placeholder="LINE„Åã„Çâ„Ç≥„Éî„Éº&„Éö„Éº„Çπ„Éà„Åß„Åç„Åæ„Åô&#10;‰æãÔºö‚óã‚óãÂ∑•Â†¥ Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫‚óã‚óã1-2-3"></textarea>
                                        <div class="paste-help">üí° LINE„ÅÆÁèæÂ†¥ÊÉÖÂ†±„Çí„Åù„ÅÆ„Åæ„ÅæË≤º„Çä‰ªò„Åë„Åß„Åç„Åæ„Åô</div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="currentVehicleNumber">Ëªä‰∏°„Éä„É≥„Éê„ÉºÔºà‰∏ã4Ê°ÅÔºâ <span class="required">*</span></label>
                                        <input type="text" id="currentVehicleNumber" placeholder="1234" maxlength="4" pattern="[0-9]{4}">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="time-record-btn end" onclick="completeSite()" id="completeSiteBtn" disabled>
                                            ‚úÖ ÁèæÂ†¥ÁµÇ‰∫Ü
                                        </button>
                                        <div id="currentSiteEndDisplay" class="time-display hidden"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Âá¶ÁêÜÂ†¥ÊÉÖÂ†±</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facilityName">Âá¶ÁêÜÂ†¥Âêç <span class="required">*</span></label>
                                <select id="facilityName" name="facilityName" required>
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="Áü≥ÂùÇ">Áü≥ÂùÇ</option>
                                    <option value="GL">GL</option>
                                    <option value="Èñ¢Âè£">Èñ¢Âè£</option>
                                    <option value="„Ç∑„Çø„É©">„Ç∑„Çø„É©</option>
                                    <option value="„ÉÄ„Ç§„É§">„ÉÄ„Ç§„É§</option>
                                    <option value="‰∫Ä‰∫ï">‰∫Ä‰∫ï</option>
                                    <option value="Ë≤¥Ëó§">Ë≤¥Ëó§</option>
                                    <option value="PSC">PSC</option>
                                    <option value="Âèã‰º∏">Âèã‰º∏</option>
                                    <option value="ÂèãÂíå">ÂèãÂíå</option>
                                    <option value="„Ç≥„Éº„Ç®„Ç§">„Ç≥„Éº„Ç®„Ç§</option>
                                    <option value="„ÇØ„ÉÑ„Ç´„Çø">„ÇØ„ÉÑ„Ç´„Çø</option>
                                    <option value="ÊòéÁõõ">ÊòéÁõõ</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Âá¶ÁêÜÂ†¥Âà∞ÁùÄ</label>
                                <button type="button" class="time-record-btn site" onclick="recordFacilityArrival()">
                                    üè≠ Âá¶ÁêÜÂ†¥Âà∞ÁùÄ
                                </button>
                                <div id="facilityArrivalDisplay" class="time-display hidden"></div>
                                <input type="hidden" id="facilityArrivalTime" name="facilityArrivalTime">
                            </div>
                            <div class="form-group">
                                <label>Ëç∑‰∏ã„Çç„ÅóÂÆå‰∫Ü</label>
                                <button type="button" class="time-record-btn end" onclick="recordFacilityEnd()" id="facilityEndBtn" disabled>
                                    ‚úÖ Ëç∑‰∏ã„Çç„ÅóÂÆå‰∫Ü
                                </button>
                                <div id="facilityEndDisplay" class="time-display hidden"></div>
                                <input type="hidden" id="facilityEndTime" name="facilityEndTime">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facilityVehicleNumber">Ëªä‰∏°„Éä„É≥„Éê„ÉºÔºà‰∏ã4Ê°ÅÔºâ <span class="required">*</span></label>
                                <input type="text" id="facilityVehicleNumber" name="facilityVehicleNumber" placeholder="1234" maxlength="4" pattern="[0-9]{4}" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="break-time-section">
                            <div class="break-time-header">
                                <h4>‚è∞ ‰ºëÊÜ©ÊôÇÈñìÁÆ°ÁêÜÔºàÂøÖÈ†àÔºö1.5ÊôÇÈñìÔºâ</h4>
                                <div class="break-remaining" id="breakRemaining">
                                    ÊÆã„Çä: 1ÊôÇÈñì30ÂàÜ
                                </div>
                            </div>
                            
                            <div class="break-controls">
                                <button type="button" class="break-btn start" id="breakStartBtn" onclick="startBreak()">
                                    ‚òï ‰ºëÊÜ©ÈñãÂßã
                                </button>
                                <button type="button" class="break-btn end" id="breakEndBtn" onclick="endBreak()" disabled>
                                    ‚úÖ ‰ºëÊÜ©ÁµÇ‰∫Ü
                                </button>
                            </div>

                            <div id="breakStatus" style="text-align: center; font-weight: bold; color: #d63031; margin: 10px 0;"></div>

                            <div class="break-history" id="breakHistory" style="display: none;">
                                <h5>üìã ‰ºëÊÜ©Â±•Ê≠¥</h5>
                                <div id="breakHistoryList"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Áî£Ê•≠ÂªÉÊ£ÑÁâ©Èñ¢ÈÄ£Êõ∏È°û</h3>
                        <p style="margin-bottom: 15px; color: #666;">ÂõûÂèé‰ºùÁ•®„Éª„Éû„Éã„Éï„Çß„Çπ„Éà„ÅÆÂÜôÁúü„Çí‰ΩïÊûö„Åß„ÇÇ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</p>
                        
                        <div class="photo-upload-summary" id="photoUploadSummary">
                            <div class="count">„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ∏à„Åø: <span id="photoCount">0</span>Êûö</div>
                            <div style="margin-top: 8px; color: #666;">‰ºùÁ•®„ÇÑ„Éû„Éã„Éï„Çß„Çπ„Éà„Çí„Å©„Çì„Å©„ÇìËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                                <button type="button" class="clear-all-photos" onclick="clearAllPhotos()" id="clearPhotosBtn" style="display: none;">ÂÖ®„Å¶ÂâäÈô§</button>
                            </div>
                        </div>
                        
                        <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                            <div style="font-size: 3em; margin-bottom: 15px;">üìÑ</div>
                            <div style="font-size: 1.2em; margin-bottom: 10px;">ÂÜôÁúü„ÇíËøΩÂä†„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                            <div style="color: #666; margin-bottom: 8px;">„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅ„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</div>
                            <div style="color: #999; font-size: 0.9em;">ÂØæÂøúÂΩ¢Âºè: JPG, PNG, PDF „Éª ‰ΩïÊûö„Åß„ÇÇOK</div>
                        </div>
                        
                        <input type="file" id="photoInput" multiple accept="image/*,.pdf" style="display: none;">
                        
                        <div class="photo-preview-grid" id="photoPreviewGrid"></div>
                    </div>

                    <div class="form-section">
                        <h3>Êó•Â∏∏ÁÇπÊ§úÈ†ÖÁõÆ</h3>
                        <p style="margin-bottom: 15px; color: #666;">ÂÆüÊñΩ„Åó„ÅüÁÇπÊ§úÈ†ÖÁõÆ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="cleaning-interior" name="inspection" value="ËªäÂÜÖÊ∏ÖÊéÉ">
                                <label for="cleaning-interior" class="checkbox-label">ËªäÂÜÖÊ∏ÖÊéÉ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cleaning-cargo" name="inspection" value="Ëç∑Âè∞Ê∏ÖÊéÉ">
                                <label for="cleaning-cargo" class="checkbox-label">Ëç∑Âè∞Ê∏ÖÊéÉ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="refuel" name="inspection" value="Áµ¶Ê≤π">
                                <label for="refuel" class="checkbox-label">Áµ¶Ê≤π</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="tire-check" name="inspection" value="„Çø„Ç§„É§ÁõÆË¶ñÁÇπÊ§ú">
                                <label for="tire-check" class="checkbox-label">„Çø„Ç§„É§ÁõÆË¶ñÁÇπÊ§ú</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="damage-check" name="inspection" value="„Ç≠„Ç∫„Éª„Å∏„Åì„ÅøÁ¢∫Ë™ç">
                                <label for="damage-check" class="checkbox-label">„Ç≠„Ç∫„Éª„Å∏„Åì„ÅøÁ¢∫Ë™ç</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="lifting-gear-check" name="inspection" value="Âêä„ÇäÂÖ∑Á¢∫Ë™ç">
                                <label for="lifting-gear-check" class="checkbox-label">Âêä„ÇäÂÖ∑Á¢∫Ë™ç</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Ê•≠ÂãôÁµÇ‰∫ÜË®òÈå≤</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ê•≠ÂãôÁµÇ‰∫Ü</label>
                                <button type="button" class="time-record-btn end" onclick="recordEndTime()" id="endBtn" disabled>
                                    üèÅ Áõ¥Â∏∞
                                </button>
                                <div id="endTimeDisplay" class="time-display hidden"></div>
                                <input type="hidden" id="endTime" name="endTime">
                            </div>
                        </div>
                    </div>

                    <div class="labor-time-summary" id="laborTimeSummary" style="display: none;">
                        <h4>üìä Âä¥ÂÉçÊôÇÈñìÈõÜË®à</h4>
                        <div class="labor-grid">
                            <div class="labor-item">
                                <div class="label">Âä¥ÂÉçÊôÇÈñì</div>
                                <div class="value" id="totalLaborTime">-</div>
                            </div>
                            <div class="labor-item overtime">
                                <div class="label">ÊôÇÈñìÂ§ñÂä¥ÂÉç</div>
                                <div class="value" id="overtimeHours">-</div>
                            </div>
                            <div class="labor-item">
                                <div class="label">‰ºëÊÜ©ÊôÇÈñì</div>
                                <div class="value" id="breakTimeTotal">-</div>
                            </div>
                            <div class="labor-item night">
                                <div class="label">Ê∑±Â§úÂä¥ÂÉç</div>
                                <div class="value" id="nightHours">-</div>
                            </div>
                            <div class="labor-item holiday">
                                <div class="label">‰ºëÊó•Âä¥ÂÉç</div>
                                <div class="value" id="holidayHours">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">„ÇØ„É™„Ç¢</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Êó•Â†±„ÇíÊèêÂá∫</button>
                    </div>
                </form>

                <div id="alert-container"></div>
            </div>

            <div id="mypage-section" class="section">
                <div class="my-page-header">
                    <h3>üìã „Éû„Ç§„Éö„Éº„Ç∏</h3>
                    <p id="mypageUserName"></p>
                </div>

                <div class="my-reports-list">
                    <h4>üìä Ëá™ÂàÜ„ÅÆÊó•Â†±Â±•Ê≠¥</h4>
                    <div id="myReportsList"></div>
                </div>

                <div class="form-row" style="justify-content: center;">
                    <button type="button" class="btn btn-primary" onclick="exportMyReports()">
                        üì• Ëá™ÂàÜ„ÅÆÊó•Â†±„ÇíCSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                </div>
            </div>

            <div id="admin-section" class="section">
                <div class="driver-management">
                    <h3>„Éâ„É©„Ç§„Éê„ÉºÁÆ°ÁêÜ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newDriverName">Êñ∞„Åó„ÅÑ„Éâ„É©„Ç§„Éê„ÉºÂêç</label>
                            <input type="text" id="newDriverName" placeholder="„Éâ„É©„Ç§„Éê„ÉºÂêç„ÇíÂÖ•Âäõ">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="addDriver()">ËøΩÂä†</button>
                        </div>
                    </div>
                    <div class="driver-list" id="driverList"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="filterDate">Êó•‰ªò„ÅßÁµû„ÇäËæº„Åø</label>
                        <input type="date" id="filterDate" onchange="filterReports()">
                    </div>
                    <div class="form-group">
                        <label for="filterDriver">„Éâ„É©„Ç§„Éê„Éº„ÅßÁµû„ÇäËæº„Åø</label>
                        <select id="filterDriver" onchange="filterReports()">
                            <option value="">ÂÖ®„Å¶„ÅÆ„Éâ„É©„Ç§„Éê„Éº</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="exportData()">CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    </div>
                </div>

                <table class="admin-table" id="reportsTable">
                    <thead>
                        <tr>
                            <th>Êó•‰ªò</th>
                            <th>„Éâ„É©„Ç§„Éê„ÉºÂêç</th>
                            <th>‰ΩìË™ø</th>
                            <th>„Ç¢„É´„Ç≥„Éº„É´</th>
                            <th>Ê•≠ÂãôÈñãÂßã</th>
                            <th>Ê•≠ÂãôÁµÇ‰∫Ü</th>
                            <th>Âä¥ÂÉçÊôÇÈñì</th>
                            <th>‰ºëÊÜ©ÊôÇÈñì</th>
                            <th>ÁèæÂ†¥Êï∞</th>
                            <th>Ë©≥Á¥∞</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        let drivers = JSON.parse(localStorage.getItem('drivers')) || ['Áî∞Â≥∂', 'Á¶èÁî∞', 'ÂÜÖÁî∞', 'Ëõ≠Â∑ù', 'Áî∞Èáå', 'Êà∏Â±±', 'ÊùæÊ©ã', 'Â†ÄÁ±≥', 'Â∞èÊöÆ', 'Â∑•Ëó§', 'ÊØîÂòâ', 'Ëó§Èáé', 'Ë•øÊ¢ù', '‰ªä‰∫ïÂØø', '‰ªä‰∫ïÊ∏Ö', '‰Ωê‰πÖÈñì', 'ÁæΩÈ≥•', 'Â±±‰∏≠', 'È¢®Èñì', 'Â≤©Áî∞', 'Ê©ãÊú¨', 'Â••Èáé', 'Áü≥Âû£', 'ÂéüÁî∞', 'È´ôÊ©ã', 'Èà¥Êú®', '‰ΩêËó§', 'Êü≥', 'Á¶èÂ≥∂'];
        let reports = JSON.parse(localStorage.getItem('reports')) || [];
        let currentUser = localStorage.getItem('currentUser') || null;
        
        // „É≠„Ç∞„Ç§„É≥Ê©üËÉΩ
        function login() {
            const driverName = document.getElementById('loginDriver').value;
            
            if (!driverName) {
                alert('„Éâ„É©„Ç§„Éê„ÉºÂêç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Çí‰øùÂ≠ò
            currentUser = driverName;
            localStorage.setItem('currentUser', currentUser);
            
            // „É°„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // „É¶„Éº„Ç∂„ÉºÂêç„ÇíË°®Á§∫
            document.getElementById('currentUserName').textContent = currentUser;
            
            // „Éâ„É©„Ç§„Éê„ÉºÈÅ∏Êäû„ÇíËá™ÂãïË®≠ÂÆö
            document.getElementById('driver').value = currentUser;
            
            showAlert(`${currentUser}„Åï„Çì„ÄÅ„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü`, 'success');
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊ©üËÉΩ
        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü\nÂÖ•Âäõ‰∏≠„ÅÆ„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }
        
        // Ëá™ÂàÜ„ÅÆÊó•Â†±„ÇíÂèñÂæó
        function getMyReports() {
            if (!currentUser) return [];
            return reports.filter(r => r.driver === currentUser).sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        // „Éû„Ç§„Éö„Éº„Ç∏„ÅÆÊó•Â†±„É™„Çπ„Éà„ÇíË°®Á§∫
        function displayMyReports() {
            const myReports = getMyReports();
            const listDiv = document.getElementById('myReportsList');
            const userNameEl = document.getElementById('mypageUserName');
            
            userNameEl.textContent = `${currentUser}„Åï„Çì„ÅÆÊó•Â†±‰∏ÄË¶ß`;
            
            if (myReports.length === 0) {
                listDiv.innerHTML = '<div class="no-data">„Åæ„Å†Êó•Â†±„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                return;
            }
            
            listDiv.innerHTML = '';
            
            myReports.forEach(report => {
                const card = document.createElement('div');
                card.className = 'report-card';
                card.onclick = () => showReportDetailModal(report.submittedAt);
                
                const laborHours = report.laborData ? report.laborData.totalLaborHours.toFixed(1) : '-';
                const siteCount = report.sites ? report.sites.length : 0;
                
                card.innerHTML = `
                    <div class="report-card-header">
                        <div class="report-card-date">${report.date}</div>
                        <div class="report-card-status status-completed">‚úÖ ÊèêÂá∫Ê∏à„Åø</div>
                    </div>
                    <div class="report-card-body">
                        <div>‚è∞ Âã§ÂãôÊôÇÈñì: ${report.startTime} - ${report.endTime}</div>
                        <div>üíº Âä¥ÂÉçÊôÇÈñì: ${laborHours}ÊôÇÈñì</div>
                        <div>üèóÔ∏è ÂõûÂèéÁèæÂ†¥: ${siteCount}ÁÆáÊâÄ</div>
                        <div>üè≠ Âá¶ÁêÜÂ†¥: ${report.facilityName || '-'}</div>
                    </div>
                `;
                
                listDiv.appendChild(card);
            });
        }
        
        // Ëá™ÂàÜ„ÅÆÊó•Â†±„ÇíCSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportMyReports() {
            const myReports = getMyReports();
            
            if (myReports.length === 0) {
                showAlert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊó•Â†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            let csv = '\uFEFF'; // BOM for UTF-8
            csv += 'Êó•‰ªò,„Éâ„É©„Ç§„Éê„ÉºÂêç,‰ΩìË™ø,Êò®Êô©„ÅÆ„Ç¢„É´„Ç≥„Éº„É´ÊëÇÂèñ,„Ç¢„É´„Ç≥„Éº„É´Êï∞ÂÄ§,Ê•≠ÂãôÈñãÂßãÊôÇÈñì,Ê•≠ÂãôÁµÇ‰∫ÜÊôÇÈñì,';
            csv += 'Âä¥ÂÉçÊôÇÈñì,ÊôÇÈñìÂ§ñÂä¥ÂÉç,‰ºëÊÜ©ÊôÇÈñì,Ê∑±Â§úÂä¥ÂÉç,‰ºëÊó•Âä¥ÂÉç,';
            csv += 'ÁèæÂ†¥Êï∞,ÁèæÂ†¥Ë©≥Á¥∞,Âá¶ÁêÜÂ†¥Âêç,Âá¶ÁêÜÂ†¥Âà∞ÁùÄÊôÇÈñì,Ëç∑‰∏ã„Çç„ÅóÁµÇ‰∫ÜÊôÇÈñì,Âá¶ÁêÜÂ†¥Ëªä‰∏°„Éä„É≥„Éê„Éº,Êó•Â∏∏ÁÇπÊ§úÈ†ÖÁõÆ,ÂÜôÁúüÊûöÊï∞,ÊèêÂá∫Êó•ÊôÇ\n';
            
            myReports.forEach(report => {
                const inspections = report.inspection ? report.inspection.join('„Éª') : '';
                const siteCount = report.sites ? report.sites.length : 0;
                const photoCount = report.photos ? report.photos.length : 0;
                
                let siteDetails = '';
                if (report.sites) {
                    siteDetails = report.sites.map((site, index) => 
                        `ÁèæÂ†¥${index + 1}:${site.siteName}(${site.arrivalTime}-${site.endTime})`
                    ).join('|');
                }
                
                const laborHours = report.laborData ? report.laborData.totalLaborHours.toFixed(2) : '0.00';
                const overtimeHours = report.laborData ? report.laborData.overtimeHours.toFixed(2) : '0.00';
                const breakHours = report.laborData ? report.laborData.breakHours.toFixed(2) : '0.00';
                const nightHours = report.laborData ? report.laborData.nightHours.toFixed(2) : '0.00';
                const holidayHours = report.laborData ? report.laborData.holidayHours.toFixed(2) : '0.00';
                
                csv += `"${report.date}","${report.driver}","${report.condition}","${report.alcohol}","${report.alcoholLevel}",`;
                csv += `"${report.startTime}","${report.endTime}","${laborHours}","${overtimeHours}","${breakHours}","${nightHours}","${holidayHours}",`;
                csv += `"${siteCount}","${siteDetails}",`;
                csv += `"${report.facilityName || ''}","${report.facilityArrivalTime}","${report.facilityEndTime}","****${report.facilityVehicleNumber}",`;
                csv += `"${inspections}","${photoCount}","${new Date(report.submittedAt).toLocaleString('ja-JP')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentUser}_Êó•Â†±_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // ÁèæÂú®„ÅÆÊó•Â†±„Éá„Éº„Çø
        let currentReport = {
            sites: [],
            photos: [],
            locationData: {},
            breakTimes: [], // ‰ºëÊÜ©ÊôÇÈñì„ÅÆË®òÈå≤
            totalBreakMinutes: 0 // ÂêàË®à‰ºëÊÜ©ÊôÇÈñìÔºàÂàÜÔºâ
        };

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // „É≠„Ç∞„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ
            if (currentUser) {
                // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUserName').textContent = currentUser;
                document.getElementById('driver').value = currentUser;
            } else {
                // Êú™„É≠„Ç∞„Ç§„É≥
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                return;
            }
            
            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíË®≠ÂÆö
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // „Éâ„É©„Ç§„Éê„Éº‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
            updateDriverSelects();
            updateDriverList();
            
            // ÁÆ°ÁêÜËÄÖÁîªÈù¢„ÅÆ„É¨„Éù„Éº„ÉàË°®Á§∫
            displayReports();
            
            // ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            setupPhotoUpload();
            
            // ÁèæÂ†¥ÂÖ•Âäõ„ÅÆÊ§úË®º
            setupSiteValidation();
        });

        // „Çª„ÇØ„Ç∑„Éß„É≥Âàá„ÇäÊõø„Åà
        function showSection(section) {
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // „Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫Âàá„ÇäÊõø„Åà
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');

            if (section === 'admin') {
                displayReports();
            } else if (section === 'mypage') {
                displayMyReports();
            }
        }


        // ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÈñ¢Êï∞
        function getLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const locationData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        callback(locationData);
                    },
                    function(error) {
                        console.error('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error);
                        callback(null);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error('‰ΩçÁΩÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                callback(null);
            }
        }

        // Google Maps URL„ÇíÁîüÊàê
        function generateMapUrl(lat, lng) {
            return `https://www.google.com/maps?q=${lat},${lng}`;
        }

        // ÊôÇÂàªË®òÈå≤Èñ¢Êï∞
        function recordStartTime() {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
            getLocation(function(location) {
                document.getElementById('startTime').value = timeString;
                
                if (location) {
                    currentReport.locationData.start = location;
                    document.getElementById('startTimeDisplay').innerHTML = `
                        ÈñãÂßãÊôÇÂàª: ${timeString}<br>
                        <span style="font-size: 0.85em; color: #666;">üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊ∏à„Åø</span>
                    `;
                } else {
                    document.getElementById('startTimeDisplay').textContent = `ÈñãÂßãÊôÇÂàª: ${timeString} (‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó)`;
                }
                
                document.getElementById('startTimeDisplay').classList.remove('hidden');
                
                // ÁµÇ‰∫Ü„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('endBtn').disabled = false;
                
                showAlert(location ? 'Ê•≠ÂãôÈñãÂßãÊôÇÂàª„Å®‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü' : 'Ê•≠ÂãôÈñãÂßãÊôÇÂàª„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºà‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±ÊïóÔºâ', 'success');
            });
        }

        function recordEndTime() {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
            getLocation(function(location) {
                document.getElementById('endTime').value = timeString;
                
                if (location) {
                    currentReport.locationData.end = location;
                    document.getElementById('endTimeDisplay').innerHTML = `
                        ÁµÇ‰∫ÜÊôÇÂàª: ${timeString}<br>
                        <span style="font-size: 0.85em; color: #666;">üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊ∏à„Åø</span>
                    `;
                } else {
                    document.getElementById('endTimeDisplay').textContent = `ÁµÇ‰∫ÜÊôÇÂàª: ${timeString} (‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó)`;
                }
                
                document.getElementById('endTimeDisplay').classList.remove('hidden');
                
                showAlert(location ? 'Ê•≠ÂãôÁµÇ‰∫ÜÊôÇÂàª„Å®‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü' : 'Ê•≠ÂãôÁµÇ‰∫ÜÊôÇÂàª„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºà‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±ÊïóÔºâ', 'success');
                
                // Âä¥ÂÉçÊôÇÈñì„Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
                updateLaborTimeSummary();
            });
        }

        function recordFacilityArrival() {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
            getLocation(function(location) {
                document.getElementById('facilityArrivalTime').value = timeString;
                
                if (location) {
                    currentReport.locationData.facilityArrival = location;
                    document.getElementById('facilityArrivalDisplay').innerHTML = `
                        Âà∞ÁùÄÊôÇÂàª: ${timeString}<br>
                        <span style="font-size: 0.85em; color: #666;">üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊ∏à„Åø</span>
                    `;
                } else {
                    document.getElementById('facilityArrivalDisplay').textContent = `Âà∞ÁùÄÊôÇÂàª: ${timeString} (‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó)`;
                }
                
                document.getElementById('facilityArrivalDisplay').classList.remove('hidden');
                
                // Ëç∑‰∏ã„Çç„ÅóÂÆå‰∫Ü„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('facilityEndBtn').disabled = false;
                
                showAlert(location ? 'Âá¶ÁêÜÂ†¥Âà∞ÁùÄÊôÇÂàª„Å®‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü' : 'Âá¶ÁêÜÂ†¥Âà∞ÁùÄÊôÇÂàª„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºà‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±ÊïóÔºâ', 'success');
            });
        }

        function recordFacilityEnd() {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
            getLocation(function(location) {
                document.getElementById('facilityEndTime').value = timeString;
                
                if (location) {
                    currentReport.locationData.facilityEnd = location;
                    document.getElementById('facilityEndDisplay').innerHTML = `
                        ÂÆå‰∫ÜÊôÇÂàª: ${timeString}<br>
                        <span style="font-size: 0.85em; color: #666;">üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊ∏à„Åø</span>
                    `;
                } else {
                    document.getElementById('facilityEndDisplay').textContent = `ÂÆå‰∫ÜÊôÇÂàª: ${timeString} (‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó)`;
                }
                
                document.getElementById('facilityEndDisplay').classList.remove('hidden');
                
                showAlert(location ? 'Ëç∑‰∏ã„Çç„ÅóÂÆå‰∫ÜÊôÇÂàª„Å®‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü' : 'Ëç∑‰∏ã„Çç„ÅóÂÆå‰∫ÜÊôÇÂàª„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºà‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±ÊïóÔºâ', 'success');
            });
        }


        // ‰ºëÊÜ©ÊôÇÈñìÁÆ°ÁêÜ
        let breakStartTime = null;
        const REQUIRED_BREAK_MINUTES = 90; // 1.5ÊôÇÈñì = 90ÂàÜ

        // ‰ºëÊÜ©ÊÆã„ÇäÊôÇÈñì„ÇíÊõ¥Êñ∞
        function updateBreakRemaining() {
            const remaining = REQUIRED_BREAK_MINUTES - currentReport.totalBreakMinutes;
            const remainingEl = document.getElementById('breakRemaining');
            
            if (remaining <= 0) {
                remainingEl.textContent = '‚úÖ ‰ºëÊÜ©ÂÆå‰∫Ü';
                remainingEl.className = 'break-remaining complete';
            } else {
                const hours = Math.floor(remaining / 60);
                const minutes = remaining % 60;
                remainingEl.textContent = `ÊÆã„Çä: ${hours}ÊôÇÈñì${minutes}ÂàÜ`;
                
                if (remaining > 60) {
                    remainingEl.className = 'break-remaining danger';
                } else if (remaining > 30) {
                    remainingEl.className = 'break-remaining warning';
                } else {
                    remainingEl.className = 'break-remaining danger';
                }
            }
        }

        // ‰ºëÊÜ©ÈñãÂßã
        function startBreak() {
            const now = new Date();
            breakStartTime = now;
            
            document.getElementById('breakStartBtn').disabled = true;
            document.getElementById('breakEndBtn').disabled = false;
            document.getElementById('breakStatus').textContent = 'üïê ‰ºëÊÜ©‰∏≠...';
            
            showAlert('‰ºëÊÜ©„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü', 'success');
        }

        // ‰ºëÊÜ©ÁµÇ‰∫Ü
        function endBreak() {
            if (!breakStartTime) {
                showAlert('‰ºëÊÜ©„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            const now = new Date();
            const startTime = breakStartTime.toTimeString().slice(0, 5);
            const endTime = now.toTimeString().slice(0, 5);
            
            // ‰ºëÊÜ©ÊôÇÈñì„ÇíË®àÁÆóÔºàÂàÜÔºâ
            const diffMs = now - breakStartTime;
            const diffMinutes = Math.round(diffMs / 60000);
            
            // ‰ºëÊÜ©Ë®òÈå≤„ÇíËøΩÂä†
            const breakRecord = {
                startTime: startTime,
                endTime: endTime,
                duration: diffMinutes,
                timestamp: now.toISOString()
            };
            
            currentReport.breakTimes.push(breakRecord);
            currentReport.totalBreakMinutes += diffMinutes;
            
            // UI„ÇíÊõ¥Êñ∞
            document.getElementById('breakStartBtn').disabled = false;
            document.getElementById('breakEndBtn').disabled = true;
            document.getElementById('breakStatus').textContent = '';
            
            breakStartTime = null;
            
            // ‰ºëÊÜ©Â±•Ê≠¥„ÇíË°®Á§∫
            displayBreakHistory();
            updateBreakRemaining();
            
            // Âä¥ÂÉçÊôÇÈñì„Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
            updateLaborTimeSummary();
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            showAlert(`‰ºëÊÜ©„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºà${hours}ÊôÇÈñì${minutes}ÂàÜÔºâ`, 'success');
        }

        // ‰ºëÊÜ©Â±•Ê≠¥„ÇíË°®Á§∫
        function displayBreakHistory() {
            const historyDiv = document.getElementById('breakHistory');
            const listDiv = document.getElementById('breakHistoryList');
            
            if (currentReport.breakTimes.length === 0) {
                historyDiv.style.display = 'none';
                return;
            }
            
            historyDiv.style.display = 'block';
            listDiv.innerHTML = '';
            
            currentReport.breakTimes.forEach((br, index) => {
                const hours = Math.floor(br.duration / 60);
                const minutes = br.duration % 60;
                
                const item = document.createElement('div');
                item.className = 'break-item';
                item.innerHTML = `
                    <div>
                        <span style="color: #666;">‰ºëÊÜ©${index + 1}:</span>
                        <span class="time">${br.startTime} - ${br.endTime}</span>
                    </div>
                    <div class="duration">${hours}ÊôÇÈñì${minutes}ÂàÜ</div>
                `;
                listDiv.appendChild(item);
            });
        }

        // Âä¥ÂÉçÊôÇÈñì„ÇíË®àÁÆó
        function calculateLaborHours(startTime, endTime, breakMinutes) {
            if (!startTime || !endTime) return 0;
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);
            
            // Êó•„Çí„Åæ„Åü„ÅêÂ†¥Âêà
            if (totalMinutes < 0) {
                totalMinutes += 24 * 60;
            }
            
            // ‰ºëÊÜ©ÊôÇÈñì„ÇíÂºï„Åè
            totalMinutes -= breakMinutes;
            
            return Math.max(0, totalMinutes / 60); // ÊôÇÈñì„Å´Â§âÊèõ
        }

        // Ê∑±Â§úÂä¥ÂÉçÊôÇÈñì„ÇíË®àÁÆóÔºà22:00-5:00Ôºâ
        function calculateNightHours(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            let nightMinutes = 0;
            
            // Á∞°ÊòìË®àÁÆóÔºö22:00-24:00 „Å® 0:00-5:00 „ÅÆÁØÑÂõ≤„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            for (let h = 0; h < 24; h++) {
                if ((h >= 22 || h < 5)) {
                    if ((startHour <= h && h < endHour) || 
                        (endHour < startHour && (h >= startHour || h < endHour))) {
                        nightMinutes += 60;
                    }
                }
            }
            
            return nightMinutes / 60;
        }

        // Âä¥ÂÉçÊôÇÈñì„Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
        function updateLaborTimeSummary() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!startTime || !endTime) return;
            
            const summaryDiv = document.getElementById('laborTimeSummary');
            summaryDiv.style.display = 'block';
            
            // Âä¥ÂÉçÊôÇÈñìË®àÁÆó
            const totalHours = calculateLaborHours(startTime, endTime, currentReport.totalBreakMinutes);
            const breakHours = currentReport.totalBreakMinutes / 60;
            const nightHours = calculateNightHours(startTime, endTime);
            
            // ÊôÇÈñìÂ§ñÂä¥ÂÉçÔºà8ÊôÇÈñìË∂ÖÈÅéÂàÜÔºâ
            const overtimeHours = Math.max(0, totalHours - 8);
            
            // ‰ºëÊó•Âà§ÂÆöÔºàÁ∞°ÊòìÔºöÂúüÊó•Ôºâ
            const date = new Date(document.getElementById('date').value);
            const dayOfWeek = date.getDay();
            const isHoliday = (dayOfWeek === 0 || dayOfWeek === 6);
            const holidayHours = isHoliday ? totalHours : 0;
            
            // Ë°®Á§∫
            document.getElementById('totalLaborTime').textContent = totalHours.toFixed(2) + 'ÊôÇÈñì';
            document.getElementById('overtimeHours').textContent = overtimeHours.toFixed(2) + 'ÊôÇÈñì';
            document.getElementById('breakTimeTotal').textContent = breakHours.toFixed(2) + 'ÊôÇÈñì';
            document.getElementById('nightHours').textContent = nightHours.toFixed(2) + 'ÊôÇÈñì';
            document.getElementById('holidayHours').textContent = holidayHours.toFixed(2) + 'ÊôÇÈñì';
        }

        function recordSiteArrival() {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
            getLocation(function(location) {
                if (location) {
                    currentReport.currentSiteArrivalLocation = location;
                    document.getElementById('currentSiteArrivalDisplay').innerHTML = `
                        Âà∞ÁùÄÊôÇÂàª: ${timeString}<br>
                        <span style="font-size: 0.85em; color: #666;">üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊ∏à„Åø</span>
                    `;
                } else {
                    document.getElementById('currentSiteArrivalDisplay').textContent = `Âà∞ÁùÄÊôÇÂàª: ${timeString} (‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó)`;
                }
                
                document.getElementById('currentSiteArrivalDisplay').classList.remove('hidden');
                
                // ÁèæÂ†¥ÁµÇ‰∫Ü„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('completeSiteBtn').disabled = false;
                
                // ÁèæÂ†¥„Éá„Éº„Çø„Å´Âà∞ÁùÄÊôÇÂàª„ÇíË®òÈå≤
                currentReport.currentSiteArrival = timeString;
                
                showAlert(location ? 'ÁèæÂ†¥Âà∞ÁùÄÊôÇÂàª„Å®‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü' : 'ÁèæÂ†¥Âà∞ÁùÄÊôÇÂàª„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºà‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±ÊïóÔºâ', 'success');
            });
        }

        // ÁèæÂ†¥ÂÆå‰∫ÜÂá¶ÁêÜ
        function completeSite() {
            const siteName = document.getElementById('currentSiteName').value.trim();
            const vehicleNumber = document.getElementById('currentVehicleNumber').value.trim();
            
            if (!siteName) {
                showAlert('ÁèæÂ†¥Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (!vehicleNumber || vehicleNumber.length !== 4) {
                showAlert('Ëªä‰∏°„Éä„É≥„Éê„ÉºÔºà4Ê°ÅÔºâ„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (!currentReport.currentSiteArrival) {
                showAlert('ÁèæÂ†¥Âà∞ÁùÄÊôÇÂàª„ÇíÂÖà„Å´Ë®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            const now = new Date();
            const endTime = now.toTimeString().slice(0, 5);
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæóÔºàÁµÇ‰∫ÜÊôÇÔºâ
            getLocation(function(endLocation) {
                // ÂÆå‰∫Ü„Åó„ÅüÁèæÂ†¥„Çí„É™„Çπ„Éà„Å´ËøΩÂä†
                const siteData = {
                    arrivalTime: currentReport.currentSiteArrival,
                    siteName: siteName,
                    endTime: endTime,
                    vehicleNumber: vehicleNumber,
                    completedAt: now.toISOString(),
                    arrivalLocation: currentReport.currentSiteArrivalLocation || null,
                    endLocation: endLocation
                };
                
                currentReport.sites.push(siteData);
                
                // ÂÆå‰∫ÜÁèæÂ†¥„ÇíË°®Á§∫
                displayCompletedSites();
                
                // ÁèæÂú®„ÅÆÁèæÂ†¥„Çí„É™„Çª„ÉÉ„Éà
                resetCurrentSite();
                
                showAlert(endLocation ? `ÁèæÂ†¥„Äå${siteName}„Äç„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºà‰ΩçÁΩÆÊÉÖÂ†±Ë®òÈå≤Ê∏à„ÅøÔºâ` : `ÁèæÂ†¥„Äå${siteName}„Äç„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü`, 'success');
            });
        }

        // ÂÆå‰∫Ü„Åó„ÅüÁèæÂ†¥„ÅÆË°®Á§∫
        function displayCompletedSites() {
            const container = document.getElementById('sitesContainer');
            container.innerHTML = '';
            
            currentReport.sites.forEach((site, index) => {
                const siteDiv = document.createElement('div');
                siteDiv.className = 'site-item completed';
                siteDiv.innerHTML = `
                    <div class="site-status completed">ÂÆå‰∫Ü #${index + 1}</div>
                    <div><strong>ÁèæÂ†¥Âêç:</strong> ${site.siteName}</div>
                    <div><strong>Âà∞ÁùÄÊôÇÂàª:</strong> ${site.arrivalTime} ‚Üí <strong>ÁµÇ‰∫ÜÊôÇÂàª:</strong> ${site.endTime}</div>
                    <div><strong>Ëªä‰∏°„Éä„É≥„Éê„Éº:</strong> ****${site.vehicleNumber}</div>
                `;
                container.appendChild(siteDiv);
            });
        }

        // ÁèæÂú®„ÅÆÁèæÂ†¥„Çí„É™„Çª„ÉÉ„Éà
        function resetCurrentSite() {
            document.getElementById('currentSiteName').value = '';
            document.getElementById('currentVehicleNumber').value = '';
            document.getElementById('currentSiteArrivalDisplay').classList.add('hidden');
            document.getElementById('currentSiteEndDisplay').classList.add('hidden');
            document.getElementById('completeSiteBtn').disabled = true;
            
            currentReport.currentSiteArrival = null;
            currentReport.currentSiteArrivalLocation = null;
        }

        // ÁèæÂ†¥ÂÖ•Âäõ„ÅÆÊ§úË®ºË®≠ÂÆö
        function setupSiteValidation() {
            const siteNameInput = document.getElementById('currentSiteName');
            const vehicleInput = document.getElementById('currentVehicleNumber');
            const facilityVehicleInput = document.getElementById('facilityVehicleNumber');
            
            // Ëªä‰∏°„Éä„É≥„Éê„Éº„ÅØÊï∞Â≠ó„ÅÆ„ÅøÂèó„Åë‰ªò„Åë
            vehicleInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
            
            facilityVehicleInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }

        // ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆö
        function setupPhotoUpload() {
            const photoInput = document.getElementById('photoInput');
            const uploadArea = document.getElementById('photoUploadArea');
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
            photoInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆÂá¶ÁêÜ
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
        }

        // „Éï„Ç°„Ç§„É´Âá¶ÁêÜ
        function handleFiles(files) {
            let validFiles = 0;
            let invalidFiles = 0;
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                    validFiles++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoData = {
                            name: file.name,
                            type: file.type,
                            data: e.target.result,
                            size: file.size,
                            uploadedAt: new Date().toISOString()
                        };
                        
                        currentReport.photos.push(photoData);
                        displayPhotoPreview();
                        updatePhotoCount();
                    };
                    reader.readAsDataURL(file);
                } else {
                    invalidFiles++;
                }
            });
            
            if (validFiles > 0) {
                showAlert(`${validFiles}Êûö„ÅÆÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
            }
            if (invalidFiles > 0) {
                showAlert(`${invalidFiles}Êûö„ÅÆ„Éï„Ç°„Ç§„É´„Åå„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„ÅüÔºàJPG, PNG, PDF„ÅÆ„ÅøÂØæÂøúÔºâ`, 'error');
            }
        }

        // ÂÜôÁúü„Éó„É¨„Éì„É•„ÉºË°®Á§∫
        function displayPhotoPreview() {
            const grid = document.getElementById('photoPreviewGrid');
            grid.innerHTML = '';
            
            currentReport.photos.forEach((photo, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'photo-preview';
                
                // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„ÅÆÂà§ÂÆö
                const isManifest = photo.name.toLowerCase().includes('„Éû„Éã„Éï„Çß„Çπ„Éà') || 
                                 photo.name.toLowerCase().includes('manifest');
                const isReceipt = photo.name.toLowerCase().includes('‰ºùÁ•®') || 
                                photo.name.toLowerCase().includes('„É¨„Ç∑„Éº„Éà') || 
                                photo.name.toLowerCase().includes('receipt');
                
                let typeLabel = 'Êõ∏È°û';
                if (isManifest) typeLabel = '„Éû„Éã„Éï„Çß„Çπ„Éà';
                else if (isReceipt) typeLabel = '‰ºùÁ•®';
                
                if (photo.type.startsWith('image/')) {
                    previewDiv.innerHTML = `
                        <div class="photo-type-label">${typeLabel}</div>
                        <img src="${photo.data}" alt="${photo.name}">
                        <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                        <div class="photo-label">${photo.name}</div>
                    `;
                } else if (photo.type === 'application/pdf') {
                    previewDiv.innerHTML = `
                        <div class="photo-type-label">${typeLabel}</div>
                        <div style="width: 100%; height: 140px; background: #f8f9fa; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px solid #dee2e6;">
                            <div style="font-size: 2.5em;">üìÑ</div>
                            <div style="font-size: 0.75em; text-align: center; padding: 5px; word-wrap: break-word;">${photo.name}</div>
                        </div>
                        <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                    `;
                }
                
                grid.appendChild(previewDiv);
            });
        }

        // ÂÜôÁúüÂâäÈô§
        function removePhoto(index) {
            const photoName = currentReport.photos[index].name;
            currentReport.photos.splice(index, 1);
            displayPhotoPreview();
            updatePhotoCount();
            showAlert(`„Äå${photoName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
        }
        
        // ÂÖ®ÂÜôÁúüÂâäÈô§
        function clearAllPhotos() {
            if (currentReport.photos.length === 0) {
                showAlert('ÂâäÈô§„Åô„ÇãÂÜôÁúü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            if (confirm(`${currentReport.photos.length}Êûö„ÅÆÂÜôÁúü„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                const count = currentReport.photos.length;
                currentReport.photos = [];
                displayPhotoPreview();
                updatePhotoCount();
                showAlert(`${count}Êûö„ÅÆÂÜôÁúü„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
            }
        }
        
        // ÂÜôÁúüÊï∞Êõ¥Êñ∞
        function updatePhotoCount() {
            const count = currentReport.photos.length;
            document.getElementById('photoCount').textContent = count;
            
            const clearBtn = document.getElementById('clearPhotosBtn');
            if (count > 0) {
                clearBtn.style.display = 'inline-block';
            } else {
                clearBtn.style.display = 'none';
            }
        }

        // „Éâ„É©„Ç§„Éê„ÉºÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
        function updateDriverSelects() {
            const driverSelect = document.getElementById('driver');
            const filterDriverSelect = document.getElementById('filterDriver');
            
            // Êó¢Â≠ò„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢ÔºàÊúÄÂàù„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÅØÊÆã„ÅôÔºâ
            driverSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            filterDriverSelect.innerHTML = '<option value="">ÂÖ®„Å¶„ÅÆ„Éâ„É©„Ç§„Éê„Éº</option>';
            
            drivers.forEach(driver => {
                const option1 = document.createElement('option');
                option1.value = driver;
                option1.textContent = driver;
                driverSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = driver;
                option2.textContent = driver;
                filterDriverSelect.appendChild(option2);
            });
        }

        // „Éâ„É©„Ç§„Éê„ÉºËøΩÂä†
        function addDriver() {
            const nameInput = document.getElementById('newDriverName');
            const name = nameInput.value.trim();
            
            if (name && !drivers.includes(name)) {
                drivers.push(name);
                localStorage.setItem('drivers', JSON.stringify(drivers));
                updateDriverSelects();
                updateDriverList();
                nameInput.value = '';
                showAlert('„Éâ„É©„Ç§„Éê„Éº„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
            } else if (drivers.includes(name)) {
                showAlert('„Åù„ÅÆ„Éâ„É©„Ç§„Éê„Éº„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', 'error');
            } else {
                showAlert('„Éâ„É©„Ç§„Éê„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            }
        }

        // „Éâ„É©„Ç§„Éê„ÉºÂâäÈô§
        function removeDriver(name) {
            if (confirm(`„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                drivers = drivers.filter(driver => driver !== name);
                localStorage.setItem('drivers', JSON.stringify(drivers));
                updateDriverSelects();
                updateDriverList();
                showAlert('„Éâ„É©„Ç§„Éê„Éº„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
            }
        }

        // „Éâ„É©„Ç§„Éê„Éº‰∏ÄË¶ßË°®Á§∫Êõ¥Êñ∞
        function updateDriverList() {
            const driverList = document.getElementById('driverList');
            driverList.innerHTML = '';
            
            drivers.forEach(driver => {
                const tag = document.createElement('div');
                tag.className = 'driver-tag';
                tag.innerHTML = `
                    ${driver}
                    <span class="remove-btn" onclick="removeDriver('${driver}')">&times;</span>
                `;
                driverList.appendChild(tag);
            });
        }

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Âü∫Êú¨ÁöÑ„Å™Ê§úË®º
            if (currentReport.sites.length === 0) {
                showAlert('Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆÁèæÂ†¥„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            // ‰ºëÊÜ©ÊôÇÈñì„ÉÅ„Çß„ÉÉ„ÇØ
            if (currentReport.totalBreakMinutes < REQUIRED_BREAK_MINUTES) {
                const remaining = REQUIRED_BREAK_MINUTES - currentReport.totalBreakMinutes;
                const hours = Math.floor(remaining / 60);
                const minutes = remaining % 60;
                if (!confirm(`‰ºëÊÜ©ÊôÇÈñì„Åå${hours}ÊôÇÈñì${minutes}ÂàÜ‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n„Åì„ÅÆ„Åæ„ÅæÊèêÂá∫„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
            }
            
            // ‰ºëÊÜ©‰∏≠„ÅÆÂ†¥Âêà
            if (breakStartTime) {
                showAlert('‰ºëÊÜ©„ÇíÁµÇ‰∫Ü„Åó„Å¶„Åã„ÇâÊèêÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            const formData = new FormData(this);
            const report = {};
            
            // Âü∫Êú¨„Éá„Éº„Çø„ÅÆÂèñÂæó
            for (let [key, value] of formData.entries()) {
                if (key === 'inspection') {
                    if (!report.inspection) report.inspection = [];
                    report.inspection.push(value);
                } else {
                    report[key] = value;
                }
            }
            
            // ÁÇπÊ§úÈ†ÖÁõÆ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó„ÇíË®≠ÂÆö
            if (!report.inspection) {
                report.inspection = [];
            }
            
            // ÁèæÂ†¥„Éá„Éº„Çø„Å®ÂÜôÁúü„Éá„Éº„Çø„ÄÅ‰ΩçÁΩÆÊÉÖÂ†±„ÇíËøΩÂä†
            report.sites = currentReport.sites;
            report.photos = currentReport.photos;
            report.locationData = currentReport.locationData;
            report.breakTimes = currentReport.breakTimes;
            
            // Âä¥ÂÉçÊôÇÈñì„Éá„Éº„Çø„ÇíË®àÁÆó„Åó„Å¶ËøΩÂä†
            const laborHours = calculateLaborHours(report.startTime, report.endTime, currentReport.totalBreakMinutes);
            const nightHours = calculateNightHours(report.startTime, report.endTime);
            const overtimeHours = Math.max(0, laborHours - 8);
            const date = new Date(report.date);
            const isHoliday = (date.getDay() === 0 || date.getDay() === 6);
            
            report.laborData = {
                totalLaborHours: laborHours,
                overtimeHours: overtimeHours,
                breakHours: currentReport.totalBreakMinutes / 60,
                nightHours: nightHours,
                holidayHours: isHoliday ? laborHours : 0,
                isHoliday: isHoliday
            };
            
            // ÊèêÂá∫Êó•ÊôÇ„ÇíËøΩÂä†
            report.submittedAt = new Date().toISOString();
            
            // Âêå„ÅòÊó•‰ªò„Éª„Éâ„É©„Ç§„Éê„Éº„ÅÆÊó¢Â≠ò„É¨„Éù„Éº„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const existingIndex = reports.findIndex(r => 
                r.date === report.date && r.driver === report.driver
            );
            
            if (existingIndex !== -1) {
                if (confirm('Âêå„ÅòÊó•‰ªò„ÅÆÊó•Â†±„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü')) {
                    reports[existingIndex] = report;
                } else {
                    return;
                }
            } else {
                reports.push(report);
            }
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem('reports', JSON.stringify(reports));
            
            // ExcelÂΩ¢Âºè„ÅßËá™Âãï„Ç®„ÇØ„Çπ„Éù„Éº„Éà
            try {
                autoExportToExcel(report);
                showAlert('Êó•Â†±„ÇíÊèêÂá∫„Åó„ÄÅExcelÈõÜË®à„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                showAlert('Êó•Â†±„ÇíÊèêÂá∫„Åó„Åæ„Åó„ÅüÔºà„Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅØÊâãÂãï„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºâ', 'success');
            }
            
            clearForm();
        });

        // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
        function clearForm() {
            document.getElementById('reportForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // ÊôÇÂàªË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.time-display').forEach(el => el.classList.add('hidden'));
            document.getElementById('endBtn').disabled = true;
            document.getElementById('facilityEndBtn').disabled = true;
            
            // ÁèæÂ†¥„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
            currentReport = { sites: [], photos: [], locationData: {}, breakTimes: [], totalBreakMinutes: 0 };
            breakStartTime = null;
            
            // ‰ºëÊÜ©UI„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('breakStartBtn').disabled = false;
            document.getElementById('breakEndBtn').disabled = true;
            document.getElementById('breakStatus').textContent = '';
            document.getElementById('breakHistory').style.display = 'none';
            document.getElementById('breakRemaining').textContent = 'ÊÆã„Çä: 1ÊôÇÈñì30ÂàÜ';
            document.getElementById('breakRemaining').className = 'break-remaining danger';
            document.getElementById('laborTimeSummary').style.display = 'none';
            document.getElementById('sitesContainer').innerHTML = '';
            resetCurrentSite();
            
            // ÂÜôÁúü„Éó„É¨„Éì„É•„Éº„Çí„ÇØ„É™„Ç¢
            displayPhotoPreview();
            updatePhotoCount();
        }

        // „Ç¢„É©„Éº„ÉàË°®Á§∫
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // „É¨„Éù„Éº„ÉàË°®Á§∫
        function displayReports() {
            const tbody = document.getElementById('reportsTableBody');
            tbody.innerHTML = '';
            
            const filteredReports = getFilteredReports();
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Êó•Â†±„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }
            
            filteredReports.forEach(report => {
                const row = document.createElement('tr');
                const siteCount = report.sites ? report.sites.length : 0;
                const laborHours = report.laborData ? report.laborData.totalLaborHours.toFixed(1) : '-';
                const breakHours = report.laborData ? report.laborData.breakHours.toFixed(1) : '-';
                
                row.innerHTML = `
                    <td>${report.date}</td>
                    <td>${report.driver}</td>
                    <td>${report.condition}</td>
                    <td>${report.alcohol}</td>
                    <td>${report.startTime}</td>
                    <td>${report.endTime}</td>
                    <td><strong>${laborHours}h</strong></td>
                    <td>${breakHours}h</td>
                    <td>${siteCount}ÁÆáÊâÄ</td>
                    <td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;" onclick="showReportDetailModal('${report.submittedAt}')">Ë©≥Á¥∞</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function getFilteredReports() {
            const filterDate = document.getElementById('filterDate').value;
            const filterDriver = document.getElementById('filterDriver').value;
            
            return reports.filter(report => {
                const dateMatch = !filterDate || report.date === filterDate;
                const driverMatch = !filterDriver || report.driver === filterDriver;
                return dateMatch && driverMatch;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
        function filterReports() {
            displayReports();
        }

        // Ë©≥Á¥∞Ë°®Á§∫Ôºà„É¢„Éº„ÉÄ„É´Ôºâ
        function showReportDetailModal(submittedAt) {
            const report = reports.find(r => r.submittedAt === submittedAt);
            if (!report) return;
            
            // „É¢„Éº„ÉÄ„É´HTMLÁîüÊàê
            let modalHTML = `
                <div id="detailModal" class="modal show">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>üìã Êó•Â†±Ë©≥Á¥∞ - ${report.date} (${report.driver})</h2>
                            <button class="modal-close" onclick="closeDetailModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- Âü∫Êú¨ÊÉÖÂ†± -->
                            <div class="detail-section">
                                <h3>üë§ Âü∫Êú¨ÊÉÖÂ†±</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Êó•‰ªò</label>
                                        <div class="value">${report.date}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>„Éâ„É©„Ç§„Éê„ÉºÂêç</label>
                                        <div class="value">${report.driver}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>‰ΩìË™ø</label>
                                        <div class="value">${report.condition}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>Êò®Êô©„ÅÆ„Ç¢„É´„Ç≥„Éº„É´ÊëÇÂèñ</label>
                                        <div class="value">${report.alcohol}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>„Ç¢„É´„Ç≥„Éº„É´Êï∞ÂÄ§</label>
                                        <div class="value">${report.alcoholLevel}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>Ê•≠ÂãôÈñãÂßãÊôÇÈñì</label>
                                        <div class="value">${report.startTime}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>Ê•≠ÂãôÁµÇ‰∫ÜÊôÇÈñì</label>
                                        <div class="value">${report.endTime}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>ÊèêÂá∫Êó•ÊôÇ</label>
                                        <div class="value">${new Date(report.submittedAt).toLocaleString('ja-JP')}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÁèæÂ†¥ÊÉÖÂ†± -->
                            <div class="detail-section">
                                <h3>üèóÔ∏è ÁèæÂ†¥ÊÉÖÂ†±Ôºà${report.sites ? report.sites.length : 0}ÁÆáÊâÄÔºâ</h3>
            `;
            
            if (report.sites && report.sites.length > 0) {
                report.sites.forEach((site, index) => {
                    modalHTML += `
                        <div class="site-card">
                            <div class="site-card-header">ÁèæÂ†¥ ${index + 1}</div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>ÁèæÂ†¥Âêç</label>
                                    <div class="value">${site.siteName}</div>
                                </div>
                                <div class="detail-item">
                                    <label>Âà∞ÁùÄÊôÇÂàª</label>
                                    <div class="value">${site.arrivalTime}</div>
                                </div>
                                <div class="detail-item">
                                    <label>ÁµÇ‰∫ÜÊôÇÂàª</label>
                                    <div class="value">${site.endTime}</div>
                                </div>
                                <div class="detail-item">
                                    <label>Ëªä‰∏°„Éä„É≥„Éê„Éº</label>
                                    <div class="value">****${site.vehicleNumber}</div>
                                </div>
                    `;
                    
                    // ÁèæÂ†¥Âà∞ÁùÄ„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±
                    if (site.arrivalLocation) {
                        const loc = site.arrivalLocation;
                        modalHTML += `
                                <div class="detail-item">
                                    <label>üìç Âà∞ÁùÄÂú∞ÁÇπ</label>
                                    <div class="value">
                                        <a href="${generateMapUrl(loc.latitude, loc.longitude)}" target="_blank" style="color: #4a90e2; text-decoration: none;">
                                            Google„Éû„ÉÉ„Éó„ÅßÈñã„Åè
                                        </a>
                                    </div>
                                </div>
                        `;
                    }
                    
                    // ÁèæÂ†¥ÁµÇ‰∫Ü„ÅÆ‰ΩçÁΩÆÊÉÖÂ†±
                    if (site.endLocation) {
                        const loc = site.endLocation;
                        modalHTML += `
                                <div class="detail-item">
                                    <label>üìç ÁµÇ‰∫ÜÂú∞ÁÇπ</label>
                                    <div class="value">
                                        <a href="${generateMapUrl(loc.latitude, loc.longitude)}" target="_blank" style="color: #4a90e2; text-decoration: none;">
                                            Google„Éû„ÉÉ„Éó„ÅßÈñã„Åè
                                        </a>
                                    </div>
                                </div>
                        `;
                    }
                    
                    modalHTML += `
                            </div>
                        </div>
                    `;
                });
            } else {
                modalHTML += '<div class="no-data">ÁèæÂ†¥ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
            
            modalHTML += `
                            </div>

                            <!-- Âá¶ÁêÜÂ†¥ÊÉÖÂ†± -->
                            <div class="detail-section">
                                <h3>üè≠ Âá¶ÁêÜÂ†¥ÊÉÖÂ†±</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Âá¶ÁêÜÂ†¥Âêç</label>
                                        <div class="value">${report.facilityName || 'Êú™Ë®òÂÖ•'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>Âà∞ÁùÄÊôÇÂàª</label>
                                        <div class="value">${report.facilityArrivalTime}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>Ëç∑‰∏ã„Çç„ÅóÂÆå‰∫ÜÊôÇÂàª</label>
                                        <div class="value">${report.facilityEndTime}</div>
                                    </div>
                                    <div class="detail-item">
                                        <label>Ëªä‰∏°„Éä„É≥„Éê„Éº</label>
                                        <div class="value">****${report.facilityVehicleNumber}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êó•Â∏∏ÁÇπÊ§ú -->
                            <div class="detail-section">
                                <h3>‚úÖ Êó•Â∏∏ÁÇπÊ§úÈ†ÖÁõÆ</h3>
            `;
            
            if (report.inspection && report.inspection.length > 0) {
                modalHTML += '<div class="inspection-badges">';
                report.inspection.forEach(item => {
                    modalHTML += `<div class="inspection-badge">‚úì ${item}</div>`;
                });
                modalHTML += '</div>';
            } else {
                modalHTML += '<div class="no-data">ÁÇπÊ§úÈ†ÖÁõÆ„Åå„ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
            }
            
            modalHTML += `
                            </div>

                            <!-- ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº -->
                            <div class="detail-section">
                                <h3>üì∏ „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÜôÁúüÔºà${report.photos ? report.photos.length : 0}ÊûöÔºâ</h3>
            `;
            
            if (report.photos && report.photos.length > 0) {
                modalHTML += '<div class="photo-gallery">';
                report.photos.forEach((photo, index) => {
                    if (photo.type.startsWith('image/')) {
                        modalHTML += `
                            <div class="photo-gallery-item" onclick="showImageModal('${photo.data}')">
                                <img src="${photo.data}" alt="${photo.name}">
                                <div class="photo-caption">${photo.name}</div>
                            </div>
                        `;
                    } else if (photo.type === 'application/pdf') {
                        modalHTML += `
                            <div class="photo-gallery-item">
                                <div class="pdf-preview">
                                    <div class="icon">üìÑ</div>
                                    <div>PDF</div>
                                </div>
                                <div class="photo-caption">${photo.name}</div>
                            </div>
                        `;
                    }
                });
                modalHTML += '</div>';
            } else {
                modalHTML += '<div class="no-data">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„ÅüÂÜôÁúü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
            
            modalHTML += `
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-print" onclick="printReport()">üñ®Ô∏è Âç∞Âà∑</button>
                            <button class="btn btn-secondary" onclick="closeDetailModal()">Èñâ„Åò„Çã</button>
                        </div>
                    </div>
                </div>
            `;
            
            // „É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†
            const existingModal = document.getElementById('detailModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // ÁîªÂÉèÊã°Â§ß„É¢„Éº„ÉÄ„É´
        function showImageModal(imageSrc) {
            let imageModalHTML = `
                <div id="imageModal" class="image-modal show" onclick="closeImageModal()">
                    <span class="image-modal-close">&times;</span>
                    <img src="${imageSrc}" alt="Êã°Â§ßÁîªÂÉè">
                </div>
            `;
            
            const existingImageModal = document.getElementById('imageModal');
            if (existingImageModal) {
                existingImageModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', imageModalHTML);
        }

        // ÁîªÂÉè„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Âç∞Âà∑
        function printReport() {
            window.print();
        }

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('detailModal');
            if (modal && event.target === modal) {
                closeDetailModal();
            }
        });

        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            const filteredReports = getFilteredReports();
            
            if (filteredReports.length === 0) {
                showAlert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            let csv = '\uFEFF'; // BOM for UTF-8
            csv += 'Êó•‰ªò,„Éâ„É©„Ç§„Éê„ÉºÂêç,‰ΩìË™ø,Êò®Êô©„ÅÆ„Ç¢„É´„Ç≥„Éº„É´ÊëÇÂèñ,„Ç¢„É´„Ç≥„Éº„É´Êï∞ÂÄ§,Ê•≠ÂãôÈñãÂßãÊôÇÈñì,Ê•≠ÂãôÁµÇ‰∫ÜÊôÇÈñì,';
            csv += 'Âä¥ÂÉçÊôÇÈñì,ÊôÇÈñìÂ§ñÂä¥ÂÉç,‰ºëÊÜ©ÊôÇÈñì,Ê∑±Â§úÂä¥ÂÉç,‰ºëÊó•Âä¥ÂÉç,';
            csv += 'ÁèæÂ†¥Êï∞,ÁèæÂ†¥Ë©≥Á¥∞,Âá¶ÁêÜÂ†¥Âêç,Âá¶ÁêÜÂ†¥Âà∞ÁùÄÊôÇÈñì,Ëç∑‰∏ã„Çç„ÅóÁµÇ‰∫ÜÊôÇÈñì,Âá¶ÁêÜÂ†¥Ëªä‰∏°„Éä„É≥„Éê„Éº,Êó•Â∏∏ÁÇπÊ§úÈ†ÖÁõÆ,ÂÜôÁúüÊûöÊï∞,ÊèêÂá∫Êó•ÊôÇ\n';
            
            filteredReports.forEach(report => {
                const inspections = report.inspection ? report.inspection.join('„Éª') : '';
                const siteCount = report.sites ? report.sites.length : 0;
                const photoCount = report.photos ? report.photos.length : 0;
                
                let siteDetails = '';
                if (report.sites) {
                    siteDetails = report.sites.map((site, index) => 
                        `ÁèæÂ†¥${index + 1}:${site.siteName}(${site.arrivalTime}-${site.endTime})`
                    ).join('|');
                }
                
                const laborHours = report.laborData ? report.laborData.totalLaborHours.toFixed(2) : '0.00';
                const overtimeHours = report.laborData ? report.laborData.overtimeHours.toFixed(2) : '0.00';
                const breakHours = report.laborData ? report.laborData.breakHours.toFixed(2) : '0.00';
                const nightHours = report.laborData ? report.laborData.nightHours.toFixed(2) : '0.00';
                const holidayHours = report.laborData ? report.laborData.holidayHours.toFixed(2) : '0.00';
                
                csv += `"${report.date}","${report.driver}","${report.condition}","${report.alcohol}","${report.alcoholLevel}",`;
                csv += `"${report.startTime}","${report.endTime}","${laborHours}","${overtimeHours}","${breakHours}","${nightHours}","${holidayHours}",`;
                csv += `"${siteCount}","${siteDetails}",`;
                csv += `"${report.facilityName || ''}","${report.facilityArrivalTime}","${report.facilityEndTime}","****${report.facilityVehicleNumber}",`;
                csv += `"${inspections}","${photoCount}","${new Date(report.submittedAt).toLocaleString('ja-JP')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `„Éâ„É©„Ç§„Éê„ÉºÊó•Â†±_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // ExcelÂΩ¢Âºè„Åß„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºàÊó•Â†±ÊèêÂá∫ÊôÇ„Å´Ëá™ÂãïÂÆüË°åÔºâ
        function autoExportToExcel(report) {
            // Êó¢Â≠ò„ÅÆÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó
            const allReports = reports;
            
            // Excel‰∫íÊèõ„ÅÆCSV„ÇíÁîüÊàê
            let csv = '\uFEFF'; // BOM for UTF-8 (Excel„ÅßÊ≠£„Åó„ÅèÈñã„Åè„Åü„ÇÅ)
            csv += 'Êó•‰ªò,„Éâ„É©„Ç§„Éê„ÉºÂêç,‰ΩìË™ø,Êò®Êô©„ÅÆ„Ç¢„É´„Ç≥„Éº„É´ÊëÇÂèñ,„Ç¢„É´„Ç≥„Éº„É´Êï∞ÂÄ§,Ê•≠ÂãôÈñãÂßãÊôÇÈñì,Ê•≠ÂãôÁµÇ‰∫ÜÊôÇÈñì,';
            csv += 'Âä¥ÂÉçÊôÇÈñì,ÊôÇÈñìÂ§ñÂä¥ÂÉç,‰ºëÊÜ©ÊôÇÈñì,Ê∑±Â§úÂä¥ÂÉç,‰ºëÊó•Âä¥ÂÉç,';
            csv += 'ÁèæÂ†¥Êï∞,ÁèæÂ†¥Ë©≥Á¥∞,Âá¶ÁêÜÂ†¥Âêç,Âá¶ÁêÜÂ†¥Âà∞ÁùÄÊôÇÈñì,Ëç∑‰∏ã„Çç„ÅóÁµÇ‰∫ÜÊôÇÈñì,Âá¶ÁêÜÂ†¥Ëªä‰∏°„Éä„É≥„Éê„Éº,Êó•Â∏∏ÁÇπÊ§úÈ†ÖÁõÆ,ÂÜôÁúüÊûöÊï∞,ÊèêÂá∫Êó•ÊôÇ\n';
            
            // ÂÖ®Êó•Â†±„Éá„Éº„Çø„ÇíCSV„Å´ËøΩÂä†
            allReports.forEach(r => {
                const inspections = r.inspection ? r.inspection.join('„Éª') : '';
                const siteCount = r.sites ? r.sites.length : 0;
                const photoCount = r.photos ? r.photos.length : 0;
                
                let siteDetails = '';
                if (r.sites) {
                    siteDetails = r.sites.map((site, index) => 
                        `ÁèæÂ†¥${index + 1}:${site.siteName}(${site.arrivalTime}-${site.endTime})`
                    ).join('|');
                }
                
                const laborHours = r.laborData ? r.laborData.totalLaborHours.toFixed(2) : '0.00';
                const overtimeHours = r.laborData ? r.laborData.overtimeHours.toFixed(2) : '0.00';
                const breakHours = r.laborData ? r.laborData.breakHours.toFixed(2) : '0.00';
                const nightHours = r.laborData ? r.laborData.nightHours.toFixed(2) : '0.00';
                const holidayHours = r.laborData ? r.laborData.holidayHours.toFixed(2) : '0.00';
                
                csv += `"${r.date}","${r.driver}","${r.condition}","${r.alcohol}","${r.alcoholLevel}",`;
                csv += `"${r.startTime}","${r.endTime}","${laborHours}","${overtimeHours}","${breakHours}","${nightHours}","${holidayHours}",`;
                csv += `"${siteCount}","${siteDetails}",`;
                csv += `"${r.facilityName || ''}","${r.facilityArrivalTime}","${r.facilityEndTime}","****${r.facilityVehicleNumber}",`;
                csv += `"${inspections}","${photoCount}","${new Date(r.submittedAt).toLocaleString('ja-JP')}"\n`;
            });
            
            // CSV„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàExcel„ÅßÈñã„Åë„ÇãÔºâ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `„Éâ„É©„Ç§„Éê„ÉºÊó•Â†±ÈõÜË®à_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            return true;
        }

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢ÔºàÈñãÁô∫Áî®Ôºâ
        function clearAllData() {
            if (confirm('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.removeItem('drivers');
                localStorage.removeItem('reports');
                location.reload();
            }
        }

        // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDetailModal();
                closeImageModal();
            }
        });

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÁ¢∫Ë™çÔºàÊú™‰øùÂ≠ò„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
        window.addEventListener('beforeunload', function(e) {
            const form = document.getElementById('reportForm');
            const formData = new FormData(form);
            let hasData = false;
            
            for (let [key, value] of formData.entries()) {
                if (value && key !== 'date') {
                    hasData = true;
                    break;
                }
            }
            
            if (hasData || currentReport.sites.length > 0 || currentReport.photos.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
